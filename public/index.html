<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Node Chat</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket = io();

    // gets a new nickname
    socket.on('nickname_did_change', function (nickname) {
      $(".name").text(nickname);
    });

    // gets a new nickname and message history
    socket.on('nickname_and_message_history', function (nickname, messages) {

      $(".name").text(nickname);

      messages.forEach(function(message) {
        let timestamp = message.timestamp;
        let date = new Date(timestamp);
        let time = date.getHours() + ':' + date.getMinutes();
        let author = message.author;
        let text = message.text;
        $('.messages').append('<li>' + time + ' ' + author + ': ' + text + '</li>');
      });
    });

    // gets a new message from the server
    socket.on('new_message_from_server', function (new_message) {

      // TODO: delete the code below
      console.log('New message from the server');
      console.log(new_message);

      let timestamp = new_message.timestamp;
      let date = new Date(timestamp);
      let time = date.getHours() + ':' + date.getMinutes();
      let author = new_message.author;
      let text = new_message.text;
      $('.messages').append('<li>' + time + ' ' + author + ': '+ text + '</li>');
    });

    // gets a nre nickname color
    socket.on('nickname_color_did_change', function (obj) {
      $(".name").css("color", 'rgb(' + obj.red + ',' + obj.green + ',' + obj.blue + ')');
    });

    // gets a nre nickname color
    socket.on('users_online_did_change', function (online_users) {

      console.log("users_online_did_change");
      console.log(online_users);

      $('.users_online').empty();

      online_users.forEach(function(online_user) {
        let nickname = online_user.nickname;
        $('.users_online').append('<li>' + nickname + '</li>');
      });
    });
  </script>

  <script>
  // sends a new message
  $(document).ready(function() {
    $(".message_text_field").on("keyup", function (e) {
    if (e.keyCode == 13) {
      let author = $(".name").text();
      let text = $(this).val();
      let message = {"author": author, "text": text};
      // TODO: delete the code below
      console.log('Sending a new message to the server');
      console.log(message);
      socket.emit('new_message_from_client', message);
      $(this).val("");
    }
    });

    // removes a placeholder from the text field
    $(".message_text_field").click(function() {
      if ($(this).val() === "Write message...") {
        $(this).val("");
      }
    });

    // places a placeholder if a user has not typed anything
    $(document).on('click', function(event) {
  		if (!$(event.target).closest(".message_text_field").length) {
        if ($(".message_text_field").val() === "") {
          $(".message_text_field").val("Write message...");
        }
  		}
  	});
  });
</script>
  <p>
    You've logged in as <span class="name">Anton</span>.<br>
    Users Online<br>
    <ul class="users_online">
    </ul>
    Messages<br>
    <ul class="messages">
    </ul>
  </p>
  <input type="text" class="message_text_field" value="Write message...">
</body>
</html>
