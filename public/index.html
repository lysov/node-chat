<!doctype html>
<html lang="en">

  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <style>
    .navbar {
      height: 64px;
    }
    .bottom-row-wrapper {
      height: 64px;
      padding: 15px;
    }
    .message_text_field {
      width: 100%;
    }
    .pre-scrollable {
      max-height: calc(100vh - 64px - 64px - 16px);
      overflow-y: scroll;
    }
    </style>

    <title>Node Chat</title>
  </head>

  <body>
    <!-- navigation bar -->
    <nav class="navbar navbar-dark bg-dark">
      <a class="navbar-brand" href="">Node Chat</a>
      <span class="navbar-text ml-auto">
        <a class="nick" href="#" data-toggle="hover-over-nick" data-placement="bottom" data-html="true" title="To change your nickname: <code>/nick new-nickname</code><br>To change your nickname color: <code>/nickcolor RRGGBB</code>">Nick</a>
      </span>
    </nav>
    <!-- end of navigation bar -->

    <div class="container-fluid">
      <div class="row" style="padding: 15px 0px;">
        <!-- online users -->
        <div class="col-3 pre-scrollable" >
          <ul class="list-group users_online">
          </ul>
        </div>
        <!-- end of online users -->

        <!-- messages -->
        <div class="col-9 pre-scrollable">
          <ul class="list-group messages">
          </ul>
        </div>
        <!-- end of messages -->
      </div>
    </div>

    <div class="container-fluid">
      <div class="row bottom-row-wrapper fixed-bottom disabled">
        <!-- number of online users container-->
        <div class="col-3">
          <p class="number_of_users_online text-center">
            0 users online
          </p>
        </div>
        <!-- end of number of online users container-->

        <!-- wrtie a new message container -->
        <div class="col-9">
          <input type="text" class="message_text_field text-dark form-control" placeholder="Write message...">
        </div>
        <!-- end of wrtie a new message container -->
      </div>
    </div>

    <!-- jQuery first, then Bootstrap JS, then Popper JS, then Socket.io -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
    const socket = io();

    // gets a new nickname
    socket.on('nickname_did_change', function (nickname) {
      $(".nick").text(nickname);
    });

    // gets a new nickname and message history
    socket.on('nickname_and_message_history', function (nickname, messages) {

      $(".nick").text(nickname);

      // TODO: color the author nickname
      // check if the client is the author
      messages.forEach(function(message) {
        let timestamp = message.timestamp;
        let date = new Date(timestamp);
        let hours = date.getHours();
        let minutes = date.getMinutes() >= 10 ? date.getMinutes() : '0' + date.getMinutes();
        let time = hours + ':' + minutes;
        let author = message.author_nickname;
        let text = message.text;
        let author_nickname_color = message.author_nickname_color;
        let author_nickname_color_rgb = 'rgb(' + author_nickname_color.red + ',' + author_nickname_color.green + ',' + author_nickname_color.blue + ')';
        $('.messages').append('<li class="list-group-item">' + time + ' <span style="color: ' + author_nickname_color_rgb +'">' + author + '</span>: ' + text + '</li>');
      });
    });

    // gets a new message from the server
    socket.on('new_message_from_server', function (new_message) {

      // TODO: delete the code below
      console.log('New message from the server');
      console.log(new_message);

      let timestamp = new_message.timestamp;
      let date = new Date(timestamp);
      let hours = date.getHours();
      let minutes = date.getMinutes() >= 10 ? date.getMinutes() : '0' + date.getMinutes();
      let time = hours + ':' + minutes;
      let author = new_message.author_nickname;
      let text = new_message.text;
      let author_nickname_color = new_message.author_nickname_color;
      let author_nickname_color_rgb = 'rgb(' + author_nickname_color.red + ',' + author_nickname_color.green + ',' + author_nickname_color.blue + ')';
      $('.messages').append('<li class="list-group-item">' + time + ' <span style="color: ' + author_nickname_color_rgb +'">' + author + '</span>: ' + text + '</li>');
    });

    // gets a new nickname color
    socket.on('nickname_color_did_change', function (obj) {
      console.log(obj);
      $(".nick").css("color", 'rgb(' + obj.red + ',' + obj.green + ',' + obj.blue + ')');
    });

    // gets a nre nickname color
    socket.on('users_online_did_change', function (online_users) {

      console.log("users_online_did_change");
      console.log(online_users);

      $('.users_online').empty();

      let number_of_users_online = 0;
      online_users.forEach(function(online_user) {
        let nickname = online_user.nickname;
        let nickname_color = online_user.nickname_color;
        let nickname_color_rgb = 'rgb(' + nickname_color.red + ',' + nickname_color.green + ',' + nickname_color.blue + ')';
        $('.users_online').append('<li class="list-group-item" style="color: ' + nickname_color_rgb + ';">' + nickname + '</li>');
        number_of_users_online++;
      });
      $(".number_of_users_online").text(number_of_users_online + ' users online');
    });

    $(document).ready(function() {
      // sends a new message
      $(".message_text_field").on("keyup", function (e) {
        if (e.keyCode == 13) {
          const author = $(".nick").text();
          const text = $(this).val();
          const message = {"author_nickname": author, "text": text};
          socket.emit('new_message_from_client', message);
          $(this).val("");
        }
      });
      // hover over nick
      $('[data-toggle="hover-over-nick"]').tooltip();
    });
  </script>
  </body>

</html>
