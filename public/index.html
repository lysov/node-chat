<!doctype html>
<html lang="en">

  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Material Design for Bootstrap fonts and icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons">

    <!-- Material Design for Bootstrap CSS -->
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-material-design@4.1.1/dist/css/bootstrap-material-design.min.css" integrity="sha384-wXznGJNEXNG1NFsbm0ugrLFMQPWswR3lds2VeinahP8N0zJw9VWSopbjv2x7WCvX" crossorigin="anonymous">

    <title>Node Chat</title>
  </head>

  <body>
    <!-- navigation bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="">Node Chat</a>
      <ul class="navbar-nav ml-auto">
          <span class="navbar-text nick">
            Nick
          </span>
      </ul>
    </nav>
    <!-- end of navigation bar -->

    <div class="container-fluid">

      <p>
        <!-- You've logged in as <span class="name">Anton</span>.<br> -->
        Users Online<br>
        <ul class="users_online">
        </ul>
        Messages<br>
        <ul class="messages">
        </ul>
      </p>
      <input type="text" class="message_text_field" value="Write message...">

    </div>

    <script>
    let socket = io();

    // gets a new nickname
    socket.on('nickname_did_change', function (nickname) {
      $(".nick").text(nickname);
    });

    // gets a new nickname and message history
    socket.on('nickname_and_message_history', function (nickname, messages) {

      $(".nick").text(nickname);

      // TODO: color the author nickname
      // check if the client is the author
      messages.forEach(function(message) {
        let timestamp = message.timestamp;
        let date = new Date(timestamp);
        let hours = date.getHours();
        let minutes = date.getMinutes() >= 10 ? date.getMinutes() : '0' + date.getMinutes();
        let time = hours + ':' + minutes;
        let author = message.author_nickname;
        let text = message.text;
        let author_nickname_color = message.author_nickname_color;
        let author_nickname_color_rgb = 'rgb(' + author_nickname_color.red + ',' + author_nickname_color.green + ',' + author_nickname_color.blue + ')';
        $('.messages').append('<li>' + time + ' <span style="color: ' + author_nickname_color_rgb +'">' + author + '</span>: ' + text + '</li>');
        //$('.messages').append('<li style="color:' + 'rgb(' + author_nickname_color.red + ',' + author_nickname_color.green + ',' + author_nickname_color.blue + ')">' + time + ' ' + author + ': ' + text + '</li>');
      });
    });

    // gets a new message from the server
    socket.on('new_message_from_server', function (new_message) {

      // TODO: delete the code below
      console.log('New message from the server');
      console.log(new_message);

      let timestamp = new_message.timestamp;
      let date = new Date(timestamp);
      let hours = date.getHours();
      let minutes = date.getMinutes() >= 10 ? date.getMinutes() : '0' + date.getMinutes();
      let time = hours + ':' + minutes;
      let author = new_message.author_nickname;
      let text = new_message.text;
      let author_nickname_color = new_message.author_nickname_color;
      let author_nickname_color_rgb = 'rgb(' + author_nickname_color.red + ',' + author_nickname_color.green + ',' + author_nickname_color.blue + ')';
      $('.messages').append('<li>' + time + ' <span style="color: ' + author_nickname_color_rgb +'">' + author + '</span>: ' + text + '</li>');
    });

    // gets a new nickname color
    socket.on('nickname_color_did_change', function (obj) {
      console.log(obj);
      $(".nick").css("color", 'rgb(' + obj.red + ',' + obj.green + ',' + obj.blue + ')');
    });

    // gets a nre nickname color
    socket.on('users_online_did_change', function (online_users) {

      console.log("users_online_did_change");
      console.log(online_users);

      $('.users_online').empty();

      online_users.forEach(function(online_user) {
        let nickname = online_user.nickname;
        $('.users_online').append('<li>' + nickname + '</li>');
      });
    });

    // sends a new message
    $(document).ready(function() {
      $(".message_text_field").on("keyup", function (e) {
      if (e.keyCode == 13) {
        let author = $(".nick").text();
        let text = $(this).val();
        let message = {"author_nickname": author, "text": text};
        // TODO: delete the code below
        console.log('Sending a new message to the server');
        console.log(message);
        socket.emit('new_message_from_client', message);
        $(this).val("");
      }
      });

      // removes a placeholder from the text field
      $(".message_text_field").click(function() {
        if ($(this).val() === "Write message...") {
          $(this).val("");
        }
      });

      // places a placeholder if a user has not typed anything
      $(document).on('click', function(event) {
        if (!$(event.target).closest(".message_text_field").length) {
          if ($(".message_text_field").val() === "") {
            $(".message_text_field").val("Write message...");
          }
        }
      });
    });
    </script>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Bootstrap JS, then Material JS on top of Bootstrap JS, then Socket.io -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/popper.js@1.12.6/dist/umd/popper.js" integrity="sha384-fA23ZRQ3G/J53mElWqVJEGJzU0sTs+SvzG8fXVWP+kJQ1lwFAOkcUOysnlKJC33U" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/bootstrap-material-design@4.1.1/dist/js/bootstrap-material-design.js" integrity="sha384-CauSuKpEqAFajSpkdjv3z9t8E7RlpJ1UP0lKM/+NdtSarroVKu069AlsRPKkFBz9" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>$(document).ready(function() { $('body').bootstrapMaterialDesign(); });</script>
  </body>

</html>
